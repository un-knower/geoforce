<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>地图操作-服务-查询周边POI</title>
<link href="http://www.supermapcloud.com/demo/china/styles/action.css" rel="stylesheet" type="text/css">
</link>
<script type="text/javascript" src="../../script/SuperMap.Include.js"></script>
<script type="text/javascript" src="../../script/osp.js">
</script>
<script type="text/javascript">

	var map = null;	//地图控件
	var featuresLayer = null;	//承载 Feature 矢量图
	var markerLayer = null;//承载 Marker 地物标记
	var poiManager = null;//POI管理对象
	var poiSearchGroup = null; //保存poi搜索结果对象
	var searchGeometry = null;//查询区域
	
	//初始化地图
	function initMap() {
		
			layer = new SuperMap.Layer.CloudLayer();
			featuresLayer = new SuperMap.Layer.Vector();
			markerLayer = new SuperMap.Layer.Markers("maker");
			 map = new SuperMap.Map("mapDiv", { controls: [
                      new SuperMap.Control.PanZoomBar(),
                      new SuperMap.Control.Navigation({
                          dragPanOptions: {
                              enableKinetic: true
                          }
                      })], allOverlays: true
            });
			map.addLayer(layer);
			map.addLayer(featuresLayer);
			map.addLayer(markerLayer);
			
			map.setCenter(new SuperMap.LonLat(12958399.4681885, 4852082.44060595),11);
		
		poiSearchGroup = new SuperMap.OSP.UI.POIGroup("poi_searchGroupId");
 	    poiManager = new SuperMap.OSP.UI.POIManager(map);
 	    poiManager.markerLayer = markerLayer;
	    poiManager.addPOIGroup(poiSearchGroup);
		//绘制搜索区域
		var radius = 10000;//缓冲区半径
		var centerPoint = map.getCenter();//中心点
		searchGeometry = markRoundGeometry(centerPoint,radius);//绘制
		
		featuresLayer.style = {fillColor:"#0000FF",pointRadius:5,strokeOpacity:0.2,fillOpacity:0.2};
        var feature = new SuperMap.Feature.Vector(markRoundGeometry(centerPoint,radius));
        featuresLayer.addFeatures(feature);
	}
	
	var round = null;
function markRoundGeometry(center, radius) {
    var d360 = Math.PI * 2;
    var sidePoints = [];
    var n = 36;
    var d = d360 / n;
    for (var i = 1; i <= n; i++) {
        var rd = d * i;
        var x = center.lon + radius * Math.cos(rd);
        var y = center.lat + radius * Math.sin(rd);
        var sidePoint = new SuperMap.Geometry.Point(x, y);
        sidePoints.push(sidePoint);
    }
	var line = new SuperMap.Geometry.LinearRing(sidePoints);
	var roundRegion = new SuperMap.Geometry.Polygon(line);
	round = new SuperMap.OSP.Utility.Geometry();
	center = new SuperMap.OSP.Core.Point2D(center.lon,center.lat);
	sidePoints[0] = new SuperMap.OSP.Core.Point2D(sidePoints[0].x,sidePoints[0].y);
	var param = [center,sidePoints[0]];
	round.point2Ds = param;
    return roundRegion;
}
	
	
	var searchService = null;//搜索服务类
	var ospPager = null;//分页控件
	var pageSize = 10;//每页显示记录数
	var keywordTextId = "txtKeyword";	//查询的关键字
	var resultDivId = "resultDiv";	//显示返回结果的div的id
	var datasetName ='PbeijingP';	//数据集
	var pagerId = "folioDiv";	//显示页码的div的id
	
//周边查询
function searchPOIByPager(rowIndex){
	if (!rowIndex) {
        rowIndex = 0;//起始记录号
	}else if(rowIndex == '1') {
		rowIndex = 0;
	}else{
		rowIndex = rowIndex * 10 - 10;
	}
	if (!ospPager) {
		ospPager = new OspPager("ospPager", searchPOIByPager);
		ospPager.page = 1;

	}
	var keyword = document.getElementById(keywordTextId).value;
	var poiSearchService = new SuperMap.OSP.Service.POISearch();//查询服务接口
	var getPOIsParam = new SuperMap.OSP.Service.GetPOIsByGeometryParam();//查询参数
	
	getPOIsParam.geometry = round;//设置搜索区域
	
	getPOIsParam.keyword = keyword;
	getPOIsParam.expectCount = pageSize;
	getPOIsParam.startRecord = rowIndex;
	poiSearchService.search.url = "http://services.supermapcloud.com";//"http://www.supermapcloud.com";
	getPOIsParam.datasetName=datasetName;
	getPOIsParam.DataSourceName = 'china_poi';
	var resultObj = document.getElementById(resultDivId);
	poiSearchService.getPOIsByGeometry(getPOIsParam, function(result){
        if (result.totalCount != 0) {
            //设置分页控件的总页数
            ospPager.pageCount = Math.ceil(result.totalCount / pageSize);
            //显示分页
            ospPager.printHtml("yahoo", pagerId);
            showPoiResult(result.records);
        }
		else{
			resultObj.innerHTML = '哎呀！没有找到结果！';
			document.getElementById(pagerId).innerHTML = "";
			return false;
		}
    }, function(error){
        resultObj.innerHTML = error.information;
    });
}

//-----------------显示搜索结果---------------//

function showPoiResult(records){

    var strHtml = "";

    if (records) {

        poiSearchGroup.clearPOIs();	//清空组内所有POI

        for (var i = 0; i < records.length; i++) {

            var poiInfo = records[i];

            strHtml += '<table cellspacing="0" cellpadding="0" border="0" class="tab_color">';

            strHtml += '<tr style="height:5px"><td colspan="2"></td></tr>';

            strHtml += '<tr style="height:5px"><td align="center" width="54" valign="top" rowspan="3"><img src="../../images/' + (i + 1) + '.gif"></td>';

            strHtml += '<td width="448" valign="top"><span style="float: right; margin-right: 15px;"></span><strong><span href="javascript:positionPoi(\'' + poiInfo.code + '\',1)">' + poiInfo.name + '</span></strong></td></tr>';

            strHtml += '<tr style="height:5px;"><td colspan="2"></td></tr></table>';

            //组织poi对象

            var poi = new SuperMap.OSP.UI.POI("search_POI_" + i);	//查询的POI点对象

            poi.position = new SuperMap.OSP.Core.Point2D(parseFloat(poiInfo.x), parseFloat(poiInfo.y));//地理坐标系下点对象

            var scaledContent = new SuperMap.OSP.UI.ScaledContent();//POI显示内容

            scaledContent.content = '../../images/num_map/' + (i + 1) + '.png';

            scaledContent.offset = new SuperMap.OSP.Core.Point2D(0, 0);//偏移量,像素单位

            poi.title = poiInfo.name;

            poi.scaledContents = scaledContent;

            poi.properties = {

                code: poiInfo.code

            };

            poiSearchGroup.addPOIs(poi);

        }

        document.getElementById(resultDivId).innerHTML = strHtml;

        //更新poi分组并显示
        poiManager.editPOIGroup(poiSearchGroup);

        poiManager.refreshPOI();	//刷新地图,并显示POI
    }
    else {
        document.getElementById(resultDivId).innerHTML = "没有找到您要的结果！";
    }
}
</script>
</head>

<body onLoad="initMap()">

<!--地图控件-->
<div id="mapDiv" style="width: 880px; height: 580px;"></div>
<div id="operatePanel" style="width: 220px; left: 810px; top: 10px; float: left;

        font-size: 12px; border: solid 1px #969696; z-index: 100; padding-bottom: 5px;

        background-image: url(../../images/toolbar_backgroundb.png);"> <font style="font-family: Verdana,Arial,Helvetica,sans-serif; font-size: 100%">周边搜索：</font>
  <p> 实现基于中心位置周边查询。</p>
  &nbsp;
  <input type="text" id="txtKeyword" value="学院" />
  <input type="button" value="搜索" onClick="searchPOIByPager()" />
</div>
<div id="resultDiv" style="clear: both"></div>
<div id="folioDiv"></div>
</body>
</html>
