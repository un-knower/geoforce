<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>地图操作-服务-查询POI</title>
<link href="http://www.supermapcloud.com/demo/china/styles/action.css" rel="stylesheet" type="text/css">
</link>
<script type="text/javascript" src="../../script/SuperMap.Include.js"></script>
<script type="text/javascript" src="../../script/osp.js">
</script>
<script type="text/javascript">
var map = null;	//地图控件
	var featuresLayer = null;//承载 Feature 矢量图
	var markerLayer = null;//承载 Marker 地物标记
	var layer = null;//承载Layer 加载地图
	var poiManager = null;//POI管理对象
	var poiSearchGroup = null; //保存poi搜索结果对象
	//初始化地图
	function initMap() {	
		layer = new SuperMap.Layer.CloudLayer();
			markerLayer = new SuperMap.Layer.Markers("maker");
			 map = new SuperMap.Map("mapDiv", { controls: [
                      new SuperMap.Control.PanZoomBar(),
                      new SuperMap.Control.Navigation({
                          dragPanOptions: {
                              enableKinetic: true
                          }
                      })], allOverlays: true
            });
			map.addLayer(layer);
			map.addLayer(markerLayer);
			map.setCenter(new SuperMap.LonLat(12958399.4681885, 4852082.44060595),11);
		
		poiSearchGroup = new SuperMap.OSP.UI.POIGroup("poi_searchGroupId");
 	    poiManager = new SuperMap.OSP.UI.POIManager(map);
 	    poiManager.markerLayer = markerLayer;
	    poiManager.addPOIGroup(poiSearchGroup);
	}
	
	var searchService = null;//搜索服务类
	var ospPager = null;//分页控件
	var pageSize = 10;//每页显示记录数
	var keywordTextId = "txtKeyword";	//查询的关键字
	var resultDivId = "resultDiv";	//显示返回结果的div的id
	var datasetName ='PbeijingP';	//数据集
	var pagerId = "folioDiv";	//显示页码的div的id
	
	//查询
	function searchPOIByPager(rowIndex){

		if (!ospPager) {
			ospPager = new OspPager("ospPager", searchPOIByPager);
			ospPager.page = 1;
	
		}
	
		if (!rowIndex) {
			rowIndex = 0;//起始记录号
		}
	
		var keyword = document.getElementById(keywordTextId).value;
		var poiSearchService = new SuperMap.OSP.Service.POISearch();	//查询服务接口
		poiSearchService.search.url = "http://services.supermapcloud.com";
		var resultObj = document.getElementById(resultDivId);
		if (keyword == "") {
			var str = "搜索的关键字不能为空!";
			messageAlert(str);
			return false;
		}
		resultObj.innerHTML = '正在查询……';
		//poi查询参数
		var keywordPOIParam = new SuperMap.OSP.Service.GetPOIsParam();
			keywordPOIParam.keyword = keyword; 
			keywordPOIParam.datasetName = 'PbeijingP';
			keywordPOIParam.districtLevel = 1;

			keywordPOIParam.districtCode = '110000';
			keywordPOIParam.expectCount = 10;
			keywordPOIParam.startRecord = 0;
			keywordPOIParam.DataSourceName = 'china_poi';

			poiSearchService.getPois(keywordPOIParam, function(result){	//进行服务器交互
			if (result) {
				//openOrCloseDistrictPanel(true);
				//openOrCloseTypesPanel(true);
				//设置分页控件的总页数
				ospPager.pageCount = Math.ceil(result.totalCount / pageSize);
				//显示分页
				ospPager.printHtml("yahoo", pagerId);
				showPoiResult(result.records);//显示查询结果
			}
		}, function(error){//错误处理代码	
			alert(error.information)	
			resultObj.innerHTML = error.information;	
		});
	}
	//-----------------显示搜索结果---------------//
	var poiHashMap = null;//缓存查询的POI
	function showPoiResult(records){
		var strHtml = "";
		if (records) {
			//装载查询到的POI对象
			poiHashMap = null;
			poiHashMap = new SuperMap.OSP.Core.HashMap();
			poiSearchGroup.clearPOIs();	//清空组内所有POI
			for (var i = 0; i < records.length; i++) {
				var poiInfo = records[i];
				poiHashMap.put(poiInfo.code, poiInfo);
				strHtml += '<table cellspacing="0" cellpadding="0" border="0" class="tab_color">';
				strHtml += '<tr style="height:5px"><td colspan="2"></td></tr>';
				strHtml += '<tr style="height:5px"><td align="center" width="54" valign="top" rowspan="3"><img src="../../images/' + (i + 1) + '.gif"></td>';
				strHtml += '<td width="448" valign="top"><span style="float: right; margin-right: 15px;"></span><strong><span href="javascript:positionPoi(\'' + poiInfo.code + '\',1)">' + poiInfo.name + '</span></strong></td></tr>';
				//strHtml += '<tr><td colspan="2">地址：' + poiInfo.address + '</td></tr>';
				strHtml += '<tr style="height:5px;"><td colspan="2"></td></tr></table>';
				//组织poi对象
				var poi = new SuperMap.OSP.UI.POI("search_POI_" + i);	//查询的POI点对象
				poi.position = new SuperMap.OSP.Core.Point2D(parseFloat(poiInfo.x), parseFloat(poiInfo.y));//地理坐标系下点对象
				var scaledContent = new SuperMap.OSP.UI.ScaledContent();//POI显示内容
				scaledContent.content = '../../images/num_map/' + (i + 1) + '.png';
				scaledContent.offset = new SuperMap.OSP.Core.Point2D(0, 0);//偏移量,像素单位
				poi.title = poiInfo.name;
				poi.scaledContents = scaledContent;
				poiSearchGroup.addPOIs(poi);
			}
			document.getElementById(resultDivId).innerHTML = strHtml;
			//更新poi分组并显示
			poiManager.editPOIGroup(poiSearchGroup);
			poiManager.refreshPOI();	//刷新地图,并显示POI
		}
		else {
			document.getElementById(resultDivId).innerHTML = "没有找到您要的结果！";
		}
	}
	
</script>
</head>

<body onLoad="initMap()">

<!--地图控件-->
<div id="mapDiv" style="width: 880px; height: 580px;"></div>
<div id="operatePanel" style="width: 220px; left: 810px; top: 10px; float: left;

        font-size: 12px; border: solid 1px #969696; z-index: 100; padding-bottom: 5px;

        background-image: url(../../images/toolbar_backgroundb.png);"> <font style="font-family: Verdana,Arial,Helvetica,sans-serif; font-size: 100%">关键字搜索：</font>
  <p> 实现基于关键字查询北京市的所有POI。</p>
  &nbsp;
  <input type="text" id="txtKeyword" value="学院" />
  <input type="button" value="搜索" onClick="searchPOIByPager()" />
</div>
<div id="resultDiv" style="clear: both"></div>
<div id="folioDiv"></div>
</body>
</html>
