function filter(e,t,a){if(!a)return null;for(var i=0,r=a.length;r>i;i++){var n=a[i];a[i].name=n.name.replace("",""),a[i].parentId=n.id}return a}function beforeClick(e,t){return 1==t.isParent?!1:!0}function selectOtherUser(e,t,a){$(".span-selected-username").html("已选择用户：<b>"+a.name+"</b>")}function zTreeOnAsyncError(){alert("异步加载失败!")}function zTreeOnAsyncSuccess(){}function RelatedSelect(){this.active=!1,this.active_feature=null,this.selectedFeature=null;var e=this;return this.activate=function(t){if(!e.active){e.active_feature=t,e.active=!0,using="undefined"==typeof using?!0:using,e.using=using;var a=e.active_feature.attributes;1==a.area_status&&($("#txt_relation_areaname").val(a.relation_areaname),$("#txt_relation_areaid").val(a.relation_areaid))}},this.indexOfFeature=function(e,t){for(var a=t.features,i=a.length;i--;)if(e===a[i].attributes.id)return i;return-1},this.select=function(t){var a=t.attributes;if(a.id!=e.active_feature.attributes.id&&(null===e.selectedFeature||a.id!=e.selectedFeature.attributes.id)){if(null!=e.selectedFeature){var i=e.indexOfFeature(e.selectedFeature.attributes.id,layer_region);-1!=i&&(layer_region.features[i].style=e.selectedFeature.attributes.oldStyle)}t.style=Dituhui.Zone.getRegionRelatedSelectStyle(),$("#txt_relation_areaname").val(a.name),$("#txt_relation_areaid").val(a.id),layer_region.redraw(),e.selectedFeature=t}},this.deactivate=function(t){if(t&&null!=e.selectedFeature){var a=e.indexOfFeature(e.selectedFeature.attributes.id,layer_region);-1!=a&&(layer_region.features[a].style=e.selectedFeature.attributes.oldStyle,layer_region.redraw())}e.selectedFeature=null,e.active_feature=null,e.active=!1},this.init=function(){},this.init(),this}function AdminRegion(){this.initProvice=function(){for(var e=Dituhui.SMCity.provinces_zhixia.concat(Dituhui.SMCity.provinces,Dituhui.SMCity.province_other),t=e.length,a="",i=0;t>i;i++){var r=e[i];a+='<li code="'+r.admincode+'" level="1" name="'+r.province+'"><span>'+r.province+"</span></li>"}$("#shuttle_province").html(a)},this.autoload=!1,this.initProvice();var e=this;this.setCity=function(t){$("#shuttle_city, #shuttle_county, #shuttle_town").html(""),e.getChildren(t,2,e.displayCity)},this.displayCity=function(t){var a=t.length;if(!(1>a)){t=t.sort(function(e,t){return e.ADMINCODE-t.ADMINCODE});for(var i="",r=0;a>r;r++){var n=t[r],o=e.isSelected(n.ADMINCODE,2);i+="<li "+(o?'class="active"':"")+' code="'+n.ADMINCODE+'" level="2" name="'+n.CITY+'"><span>'+n.CITY+"</span></li>"}$("#shuttle_city").html(i)}},this.setCounty=function(t){$("#shuttle_county, #shuttle_town").html(""),e.getChildren(t,3,e.displayCounty)},this.displayCounty=function(t){var a=t.length;if(!(1>a)){t=t.sort(function(e,t){return e.ADMINCODE-t.ADMINCODE});for(var i="",r=0;a>r;r++){var n=t[r],o=e.isSelected(n.ADMINCODE,3);i+="<li "+(o?'class="active"':"")+' code="'+n.ADMINCODE+'" level="3" name="'+n.COUNTY+'"><span>'+n.COUNTY+"</span></li>"}$("#shuttle_county").html(i)}},this.setTown=function(t){Dituhui.User.hasTownAuthority&&($("#shuttle_town").html(""),e.getChildren(t,4,e.displayTown))},this.displayTown=function(t){var a=t.length;if(!(1>a)){t=t.sort(function(e,t){return e.ADMINCODE-t.ADMINCODE});for(var i="",r=0;a>r;r++){var n=t[r],o=e.isSelected(n.ADMINCODE,4);i+="<li "+(o?'class="active"':"")+' code="'+n.ADMINCODE+'" level="4" name="'+n.TOWN+'"><span>'+n.TOWN+"</span></li>"}$("#shuttle_town").html(i)}},this.getChildren=function(e,t,a){Dituhui.request({url:urls.server+"/orderService/getAdminElements?",data:{admincode:e,level:t},dataType:"json",success:function(e){e.isSuccess&&e.result&&a(e.result)},error:function(){}})},this.selectedAdmins=[],this.onSelect=function(t){if(!t.hasClass("active")){var a=t.attr("code"),i=t.attr("level"),r=t.attr("name"),n=[a,i,r];e.isAgain(n)||(t.addClass("active"),e.selectedAdmins.push(n),e.refreshSelectedAdminnames())}},this.isAgain=function(t){var a=e.selectedAdmins,i=a.length;if(1>i)return!1;if(a.indexOf(t)>-1)return!0;for(var r=i;r--;){var n=a[r][0],o=a[r][1],l=t[0],u=t[1];if(o!=u)if(Number(u)>Number(o)){if(1==o&&n.substring(0,2)===l.substring(0,2))return Dituhui.showHint("已选的行政区划包含"+t[2]+"，不能同时选择"),!0;if(2==o&&n.substring(0,4)===l.substring(0,4))return Dituhui.showHint("已选的行政区划包含"+t[2]+"，不能同时选择"),!0;if(3==o&&n.substring(0,6)===l.substring(0,6))return Dituhui.showHint("已选的行政区划包含"+t[2]+"，不能同时选择"),!0}else if(n.substring(0,2)===l.substring(0,2))return Dituhui.showHint(t[2]+"包含已选的行政区划，不能同时选择"),!0}return!1},this.isSelected=function(t,a){var i=e.selectedAdmins.concat(),r=i.length;if(1>r)return!1;for(var n=r;n--;)if(i[n][0]===t&&a==i[n][1])return!0;return!1},this.refreshSelectedAdminnames=function(){var e=this.selectedAdmins,t=e.length;if(1>t)return $("#selected_adminnames").html(""),!1;for(var a="",i=0;t>i;i++){var r=e[i];a+='<li index="'+i+'" name="'+r[2]+'" level="'+r[1]+'" code="'+r[0]+'">	<span class="text">'+(i+1)+". "+r[2]+'</span>	<span class="glyphicon glyphicon-trash" aria-hidden="true"></span></li>'}$("#selected_adminnames").html(a)},this.removeSelectedAdmin=function(){{var t=$(this).parent("li"),a=Number(t.attr("index")),i=t.attr("code");t.attr("level")}$('.shuttle li[code="'+i+'"]').removeClass("active"),e.selectedAdmins.splice(a,1),e.refreshSelectedAdminnames()},this.save=function(){var t=e.selectedAdmins.concat();if(0===t.length)return void Dituhui.showHint("请选择行政区划");var a=t.join(";");Dituhui.request({url:urls.server+"/areaService/saveSelectedAdmins?",data:{adminsLevels:a},dataType:"json",success:function(t){if(e.stopProcessTimer(),t.isSuccess){var a=t.info?t.info:"行政区划导入成功";Dituhui.Modal.loaded_right(a,function(){Dituhui.Modal.hide(),Map.search(),map.removeAllPopup(),Map.clearSelectedFeatures()})}else{var i=t.info;i&&""!==i?Dituhui.Modal.loaded_wrong(i,function(){$(".data-modal").addClass("hide")}):Dituhui.showHint("导入行政区划失败，请稍候重试")}},error:function(){}}),$(".data-import-regins").fadeOut();var i='行政区划导入中，【<span class="upload-process">1</span>/'+t.length+"】";Dituhui.Modal.loading(i),e.startProcessTimer(),e.clear()};var t=null;this.startProcessTimer=function(){t=setInterval(e.getProcess,1e3)},this.stopProcessTimer=function(){clearInterval(t)},this.getProcess=function(t){Dituhui.request({url:urls.server+"/areaService/getDataProcess?",type:"GET",success:function(a){if(a.isSuccess){var i=a.result.current;if($(".upload-process").html(0==i?1:i),i===a.result.total&&0!=a.result.total&&(e.stopProcessTimer(),e.autoload)){var r=a.info?a.info:"行政区划导入成功";Dituhui.Modal.loaded_right(r,function(){Dituhui.Modal.hide(),Map.search(),map.removeAllPopup(),Map.clearSelectedFeatures()}),e.autoload=!1}"function"==typeof t&&t(a.result.total,a.result.current)}},error:function(){}})},this.clear=function(){e.selectedAdmins=[],e.refreshSelectedAdminnames(),$("#shuttle_city").html(""),$("#shuttle_county").html(""),$("#shuttle_town").html(""),$(".shuttle li.active").removeClass("active")}}SuperMap.Control.DrawFeature=SuperMap.Class(SuperMap.Control,{snap:null,layer:null,callbacks:null,EVENT_TYPES:["featureadded"],multi:!1,featureAdded:function(){},handlerOptions:null,style:null,panCodes:[37,38,39,40],initialize:function(e,t,a){this.EVENT_TYPES=SuperMap.Control.DrawFeature.prototype.EVENT_TYPES.concat(SuperMap.Control.prototype.EVENT_TYPES),SuperMap.Control.prototype.initialize.apply(this,[a]),this.callbacks=SuperMap.Util.extend({done:this.drawFeature,modify:function(e,t){this.layer.events.triggerEvent("sketchmodified",{vertex:e,feature:t})},create:function(e,t){this.layer.events.triggerEvent("sketchstarted",{vertex:e,feature:t})}},this.callbacks),this.layer=e,this.handlerOptions=this.handlerOptions||{},"multi"in this.handlerOptions||(this.handlerOptions.multi=this.multi);var i=this.layer.styleMap&&this.layer.styleMap.styles.temporary;i&&(this.handlerOptions.layerOptions=SuperMap.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new SuperMap.StyleMap({"default":i})})),this.handler=new t(this,this.callbacks,this.handlerOptions);var r={keydown:this.handleKeypress};this.handlers={keyboard:new SuperMap.Handler.Keyboard(this,r)}},activate:function(){return this.handlers.keyboard.activate()&&SuperMap.Control.prototype.activate.apply(this,arguments)},deactivate:function(){var e=!1;return SuperMap.Control.prototype.deactivate.apply(this,arguments)&&(this.handlers.keyboard.deactivate(),e=!0),e},drawFeature:function(e){if("SuperMap.Bounds"===e.CLASS_NAME)var t=this.map.getLonLatFromPixel(new SuperMap.Pixel(e.left,e.bottom)),a=this.map.getLonLatFromPixel(new SuperMap.Pixel(e.right,e.top)),e=new SuperMap.Geometry.Rectangle(t.lon,t.lat,a.lon-t.lon,a.lat-t.lat);else if("SuperMap.Pixel"===e.CLASS_NAME)var i=this.map.getLonLatFromPixel(e),e=new SuperMap.Geometry.Point(i.lon,i.lat);var r=new SuperMap.Feature.Vector(e);this.style&&(r.style=this.style);var n=this.layer.events.triggerEvent("sketchcomplete",{feature:r});n!==!1&&(r.state=SuperMap.State.INSERT,this.layer.addFeatures([r]),this.featureAdded(r),this.events.triggerEvent("featureadded",{feature:r}))},insertXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertXY(e,t)},insertDeltaXY:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeltaXY(e,t)},insertDirectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDirectionLength(e,t)},insertDeflectionLength:function(e,t){this.handler&&this.handler.line&&this.handler.insertDeflectionLength(e,t)},undo:function(){return this.handler.undo&&this.handler.undo()},redo:function(){return this.handler.redo&&this.handler.redo()},finishSketch:function(){this.handler.finishGeometry()},cancel:function(){this.handler.cancel()},handleKeypress:function(e){var t=e.keyCode,a=150;switch(t){case 37:this.map.pan(-a,0);break;case 38:this.map.pan(0,-a);break;case 39:this.map.pan(a,0);break;case 40:this.map.pan(0,a)}},CLASS_NAME:"SuperMap.Control.DrawFeature"}),$(function(){Dituhui.User.allowTownOption=!0,Map.initMap(),$("#map").on("change","#select_region_province",Dituhui.Zone.selectRegionProvince),$("#map").on("change","#select_region_city",Dituhui.Zone.selectRegionCity),$("#map").on("change","#select_region_county",Dituhui.Zone.selectRegionCounty)});var control_drawPolygon=null,control_drawPathRegion=null,control_editPolygon=null,control_drawSplitLine=null,control_drawSplitArea=null,layer_countyboundry=null,isCtrlKeydown=!1,isFirefox=!1,layer_snap=null,layer_region_temp=null,layer_region_label_temp=null,relatedSelect,Map={allowSelect:!0,isDrawingPathRegion:!1,navigation:new SuperMap.Control.Navigation({id:"control_navigation",dragPanOptions:{enableKinetic:!0}})};Map.initMap=function(){new SuperMap.Control.PanZoomBar({showSlider:!0});map=new SuperMap.Map("map",{controls:[Map.navigation],allOverlays:!0}),layer_countyboundry=new SuperMap.Layer.CloudLayer({url:urls.map_countyboundry,resolutions:Map.cloud_resolutions.slice(10)}),map.addLayer(layer_countyboundry),layer_countyboundry.setVisibility(!1),layer_branches=new SuperMap.Layer.Vector("branches"),layer_orders=new SuperMap.Layer.Vector("orders",{renderers:["Canvas2"]}),layer_snap=new SuperMap.Layer.Vector("snap",{renderers:["Canvas2"]}),layer_snap.style=Dituhui.Zone.getSnapPointStyle();var e=new SuperMap.Strategy.GeoText;e.groupField="style_status",e.styleGroups=Dituhui.Zone.getRegionTextStyleGroups(),layer_region_label=new SuperMap.Layer.Vector("Label",{renderers:["SVG"],strategies:[e]}),layer_region=new SuperMap.Layer.Vector("region",{renderers:["SVG"]});var t=new SuperMap.Strategy.GeoText;t.groupField="style_status",t.styleGroups=Dituhui.Zone.getRegionTextStyleGroups(),layer_region_temp=new SuperMap.Layer.Vector("region_temp",{renderers:["SVG"]}),layer_region_label_temp=new SuperMap.Layer.Vector("region_temp_label",{renderers:["SVG"],strategies:[t]}),layer_edit=new SuperMap.Layer.Vector("edit"),layer_edit.style=Dituhui.Zone.getRegionEditStyle(),layer_edit_regionroute=new SuperMap.Layer.Vector("region_route"),layer_boundry=new SuperMap.Layer.Vector("boundry",{renderers:["Canvas2"]}),layer_cloudpois=new SuperMap.Layer.Vector("cloud_pois",{renderers:["Canvas2"]}),map.addLayers([layer_boundry,layer_cloudpois,layer_region_temp,layer_region_label_temp,layer_region,layer_region_label,layer_branches,layer_orders,layer_edit_regionroute,layer_snap,layer_edit]),layer_branches.setVisibility(!1),layer_region.setVisibility(!1),layer_region_label.setVisibility(!1),Map.init(!0),Measure.init(),control_drawPolygon=new SuperMap.Control.DrawFeature(layer_edit,SuperMap.Handler.Polygon,{multi:!1}),control_drawPolygon.events.on({featureadded:Map.drawRegionCompleted});var a=new SuperMap.Snap([layer_region],10,10,{actived:!0});control_drawPolygon.snap=a,control_drawSplitArea=new SuperMap.Control.DrawFeature(layer_edit,SuperMap.Handler.Polygon,{multi:!1}),control_drawSplitArea.events.on({featureadded:Map.drawSplitAreaCompleted}),control_drawSplitLine=new SuperMap.Control.DrawFeature(layer_edit,SuperMap.Handler.Path,{multi:!1},Dituhui.Zone.getSplitLineStyle()),control_drawSplitLine.events.on({featureadded:Map.drawSplitLineCompleted}),control_drawPathRegion=new SuperMap.Control.DrawFeature(layer_edit,SuperMap.Handler.Point,{multi:!0}),control_drawPathRegion.events.on({featureadded:Regionroute.drawRouteRegionCompleted});var i=new SuperMap.Snap([layer_region],10,10,{actived:!0});control_editPolygon=new SuperMap.Control.ModifyFeature(layer_edit,{standalone:!0,geometryTypes:["SuperMap.Geometry.Polygon"],toggle:!1,deleteCodes:[46,68]}),control_editPolygon.snap=i,map.addControls([control_drawPolygon,control_drawPathRegion,control_editPolygon,control_drawSplitLine,control_drawSplitArea]);Dituhui.Zone.getRegionSelectStyle();control_select=new SuperMap.Control.SelectFeature([layer_cloudpois,layer_branches,Measure.layer,layer_region,layer_region_label],{callbacks:{rightclick:Rightmenu.createMenu,click:Map.regionSelect,clickout:Map.regionUnSelect},multiple:!1,hover:!1,multipleKey:"ctrlKey",clickout:!1,repeat:!0}),map.addControl(control_select),control_select.activate();var r=new SuperMap.Control.OverviewMap({id:"overviewMap",maximized:!1}),n=new SuperMap.Layer.CloudLayer({url:urls.map_img});r.layers=[n],map.addControl(r),map.events.on({zoomend:Map.zoomEnd}),Dituhui.SMCity.initUserCity(Map.initDatas),Baidu.init(),Map.bindKeyPan(),Map.setMapIndexTop(),relatedSelect=new RelatedSelect},Map.showCountryBoundry=function(){var e=$(this).prop("checked");layer_countyboundry.setVisibility(e)},Map.disableDbClick=function(){var e=map.getControl("control_navigation");e.handlers.click["double"]=!1},Map.enableDbClick=function(){var e=map.getControl("control_navigation");e.handlers.click["double"]=!0},Map.disableDrag=function(){var e=map.getControl("control_navigation");e.dragPan.deactivate()},Map.enableDrag=function(){var e=map.getControl("control_navigation");e.dragPan.activate()},Map.initDatas=function(){if(Dituhui.SMCity.isCheckAction=!0,Dituhui.SMCity.cityTagClick=function(){$(".search-area .select-group").val("-1"),$("#txt_keyword_search_branches").val(""),$("#btn_showBranch").prop("checked")&&Map.searchBranches(),($("#btn_showRegion").prop("checked")||$(".data-list tbody tr").length>0)&&Map.searchRegions(),map.removeAllPopup();var e=$(".smcity");poisearch.city=e.attr("admincode"),2==e.attr("level")&&(poisearch.city=e.attr("admincode").substr(0,4)+"00"),poisearch.changeCity()},poisearch=new POISearch({id:"txt_keyword_cloud",city:$(".smcity").attr("admincode"),map:map,layer:layer_cloudpois,savePOI:!1}),Dituhui.User.regionTableExtend){var e='<td class="td-150">网格组编码</td><td class="td-150">网格组名称</td><td class="td-150">线路编码</td><td class="td-150">线路名称</td>';$(".data-results .data-table thead tr .thead-split").before(e)}Dituhui.User.hasTownAuthority?$(".shuttle-town .no-rights").hide():$(".shuttle-town .no-rights").show()},Map.ipLocate=function(){Dituhui.showMask(),Dituhui.IPLocate(urls.ip_locate,function(e){Dituhui.hideMask(),Dituhui.SMCity.init(e)},function(){Dituhui.hideMask(),Dituhui.SMCity.init({city:"北京"})})},Map.zoomEnd=function(e){var t=e.object.zoom;$(".olAlphaImg").attr("title",t);var a=$("#btn_showRegion"),i=a.attr("isShowRegion")?!0:!1;t>4?(a.prop("checked",i),layer_region.setVisibility(i),layer_region_label.setVisibility(i),layer_boundry.setVisibility(!0)):(a.prop("checked",!1),layer_region.setVisibility(!1),layer_region_label.setVisibility(!1),layer_boundry.setVisibility(!1))},Map.showBranchLayer=function(){var e=$(this),t=e.prop("checked");layer_branches.setVisibility(t),t&&0===layer_branches.features.length?Map.searchBranches():Map.isDragging||map.removeAllPopup()},Map.getSelectedFeatureIndex=function(e){for(var t=selectedFeatures.concat(),a=t.length;a--;)if(t[a].attributes.id===e)return a;return-1},Map.selectRegion=function(e){if(relatedSelect.active)return void(2.5!==e.attributes.style_status&&relatedSelect.select(e));if(2.5===e.attributes.style_status)$(".tool-button.region-editable").addClass("non").unbind("click"),Map.clearSelectedFeatures();else{for(var t=selectedFeatures.length;t--;)if(2.5===selectedFeatures[t].attributes.style_status){Map.clearSelectedFeatures();break}$(".tool-button.region-editable").removeClass("non"),$(".toolbox .edit").click(Regionedit.editRegionClick),$(".toolbox .delete").click(Map.deleteRegionClick),$(".toolbox .merge").click(Map.mergeRegionClick),$(".toolbox .line-split").click(Map.lineSplitRegionClick),$(".toolbox .area-split").click(Map.areaSplitRegionClick)}var a=window.event;(isFirefox&&!isCtrlKeydown||!isFirefox&&!a.ctrlKey)&&Map.clearSelectedFeatures();var i=Map.getSelectedFeatureIndex(e.attributes.id);if(0>i&&(e.attributes.oldStyle=e.style,e.style=Dituhui.Zone.getRegionSelectStyle(),selectedFeatures.push(e)),selectedFeature=e,Dituhui.Zone.Table.scrollToFeature(e),("undefined"==typeof openInfoWindow||1==openInfoWindow)&&Map.openRegionAttrPopup(e),0==layer_region.visibility){var r=selectedFeature.attributes,n=new SuperMap.Geometry.GeoText(r.center.x,r.center.y,r.name),o=new SuperMap.Feature.Vector(n,r);layer_region_temp.addFeatures([selectedFeature.clone()]),layer_region_label_temp.addFeatures([o])}layer_region.redraw()},Map.regionSelect=function(e){var t=e.attributes.type;switch(t){case"point":Map.selectBranch(e);break;case"region":Map.selectRegion(e);break;case"text-region":e=Map.getFeatureFromLayerById(e.attributes.id,layer_region.features),Map.selectRegion(e);break;case"clear-measure":Measure.clearMeasure(e);break;case"point-cloud":poisearch.openPopup(e.attributes)}},Map.regionUnSelect=function(e){return},Map.clearSelectedFeatures=function(){var e=selectedFeatures.length;if(0!==e){for(var t=e;t--;){var a=selectedFeatures[t],i=Map.getFeatureFromLayerById(a.attributes.id);i&&(i.style=i.attributes.oldStyle)}layer_region.redraw(),layer_region_temp.removeAllFeatures(),layer_region_label_temp.removeAllFeatures(),selectedFeatures=[],selectedFeature=null}},Map.openRegionAttrPopup=function(e){var t=e.attributes,a=Dituhui.Zone.getAttrRegionHtml(t),i=new SuperMap.LonLat(t.center.x,t.center.y);t.lonlat=i,Map.popup=null,Map.popup=new SuperMap.Popup.FramedCloud("popup-region",i,new SuperMap.Size(300,70),a,null,!1,null),Map.popup.autoSize=!0,Map.popup.panMapIfOutOfView=!0,Map.popup.relativePosition="tr",map.removeAllPopup(),map.addPopup(Map.popup),$(".popup-close").unbind("click").click(function(){map.removeAllPopup(),layer_region_temp.removeAllFeatures(),layer_region_label_temp.removeAllFeatures()}),$(".popup-edit").unbind("click").click(function(){Map.openEditRegionPopup(t,!1)});var r=$(".region-adminname");Dituhui.Zone.getAdminnameByCode(t.admincode,function(e){r.html(e)},function(){r.html("")})},Map.openEditRegionPopup=function(e,t){var a=Dituhui.Zone.getEditRegionHtml(1,e);Map.popup=new SuperMap.Popup.FramedCloud("popup-region",e.lonlat,new SuperMap.Size(320,200),a,null,!1,null,!0),Map.popup.autoSize=!0,Map.popup.panMapIfOutOfView=!0,Map.popup.relativePosition="tr",map.removeAllPopup(),map.addPopup(Map.popup),$("#txt_number").unbind("keyup").keyup(function(e){13==e.keyCode&&Map.getBranchName()}),$(".popup-close").unbind("click").on("click",function(){"undefined"!=typeof t&&t===!0?Map.cancelAddRegion():Dituhui.Modal.ask("确定不保存吗？",Map.cancelAddRegion)}),$(".popup-sure").unbind("click").on("click",function(){Map.updateRegionAttr(e,t)}),1==e.area_status&&relatedSelect.activate(selectedFeature),$(".popup-select-area-status").unbind("change").change(function(){var e=$(this).val(),t=$(".relate-region-content"),a=$(".map-popup .content");0==e||2==e?(relatedSelect.deactivate(!0),t.addClass("hide").find("input").val("")):(relatedSelect.activate(selectedFeature),t.removeClass("hide"),a.scrollTop(a[0].scrollHeight))}),Dituhui.Zone.initRegionPopupAdmincode(e)},Map.updateRegionAttr=function(e,t){var a=$("#txt_name").val();if(""===a||a.length<1)return void Dituhui.showHint("请输入区划名称");if(a.length>50)return void Dituhui.showHint("区划名称长度不能大于50位");var i=$("#txt_number").val();if(""===i||i.length<1)return void Dituhui.showHint("请输入区划编号");if(i.length>50)return void Dituhui.showHint("区划编号长度不能大于50位");var r=$(".popup-select-area-status").val(),n=$("#txt_relation_areaid").val(),o=$("#select_region_province").val(),l=$("#select_region_city").val(),u=$("#select_region_county").val(),s=Dituhui.User.hasTownAuthority?$("#select_region_town").val():"-1",c="";if(Dituhui.User.hasTownAuthority&&s&&"-1"!=s)c=s;else if(u&&"-1"!=u)c=u;else if(l&&"-1"!=l)c=l;else{if(!o||"-1"==o)return void Dituhui.showHint("请选择区划归属");c=o}var d={id:e.id,areaName:a,areaNum:i,admincode:c,pointid:p,areastatus:r,relationareaid:n};Dituhui.User.regionTableExtend&&(d.wgzCode=$("#txt_wgzCode").val(),d.wgzName=$("#txt_wgzName").val(),d.lineCode=$("#txt_lineCode").val(),d.lineName=$("#txt_lineName").val());var p=$("#txt_name").attr("poi-id");return a===e.name&&i===e.areaNumber&&c===e.admincode&&r==e.area_status&&n==e.relation_areaid&&Dituhui.User.regionTableExtend&&d.wgzCode===e.wgzCode&&d.wgzName===e.wgzName&&d.lineCode===e.lineCode&&d.lineName===e.lineName?void("undefined"!=typeof t&&t===!0?Map.cancelAddRegion():Dituhui.showHint("未进行修改")):void Dituhui.Zone.updateAttr(d,function(){Dituhui.showPopover('区划 "'+(a?a:item.name)+'" 属性修改成功'),map.removeAllPopup(),Map.clearSelectedFeatures(),Map.search(),relatedSelect.deactivate(!1)},function(e){e=e?e:'区划 "'+(a?a:item.name)+'" 属性修改失败',Dituhui.Modal.loaded_wrong(e,function(){$(".data-modal").addClass("hide")})})},Map.showRegionLayer=function(){var e=$(this),t=e.prop("checked");if(t){var a=$(".smcity").attr("admincode");if(!a||""===a)return Dituhui.showHint("如果查看区划，请选择省市"),void e.prop("checked",!1);var i=map.getZoom();if(5>i)return Dituhui.showHint("请将地图放大到5级以上再显示区划"),void e.prop("checked",!1);0===layer_region.features.length&&Map.searchRegions(),e.attr("isShowRegion","true"),layer_region_temp.removeAllFeatures(),layer_region_label_temp.removeAllFeatures()}else e.removeAttr("isShowRegion"),map.removeAllPopup();layer_region.setVisibility(t),layer_region_label.setVisibility(t),layer_region_temp.setVisibility(!t),layer_region_label_temp.setVisibility(!t)},Map.searchRegions=function(e){var t=$("#txt_keyword_search_regions").val(),a=$(".smcity"),i=a.attr("admincode"),r=a.attr("level");if(""===i)return void Dituhui.showPopover("查询区划请选择省");layer_region.removeAllFeatures(),layer_region_label.removeAllFeatures(),layer_region_temp.removeAllFeatures(),map.removeAllPopup(),Map.clearSelectedFeatures(),Dituhui.Zone.Table.clear(),Dituhui.showMask();var n={admincode:i,level:r};""!=t&&t.length>0&&(n.areaName=t,n.areaNumber=t),Dituhui.Zone.search(n,function(t){Dituhui.hideMask(),Map.showRegionsToMap(t),Dituhui.Zone.Table.refresh(t),"function"==typeof e&&e()},function(){Dituhui.hideMask(),"function"==typeof e?e():Dituhui.showHint("当前查询到0条区划数据")})},Map.showRegionsToMap=function(e){layer_region.removeAllFeatures(),layer_region_label.removeAllFeatures();var t=e.length;if(0===t)return void Dituhui.showPopover("当前查询到0条区划数据");for(var a=[],i=[],r=Dituhui.User.dcode,n=t;n--;){var o=e[n];o.name||(o.name="");var l=o.points,u=o.parts;if(u&&0!=u.length){var s=o;if(s.parts=null,s.points=null,s.type="region",s.branch_name=Dituhui.Zone.getBranchName(o.pointnames),Baidu&&Baidu.using){for(var c=l.length;c--;){var d=l[c],p=Baidu.getCoord(d.x,d.y);l[c].x=p.x,l[c].y=p.y}var p=Baidu.getCoord(o.center.x,o.center.y);o.center.x=p.x,o.center.y=p.y}var h=Dituhui.Zone.DrawRegion(u,l,1),g=Dituhui.Zone.getRegionStyle(o.name);o.style_status=o.area_status,s.dcode.substr(0,r.length)!==r&&(g=Dituhui.Zone.getNonEditableRegionStyle(o.name),o.style_status=2.5),s.oldStyle=g;var m=new SuperMap.Feature.Vector(h,s,g);a.push(m);var v=new SuperMap.Geometry.GeoText(o.center.x,o.center.y,o.name),y=new SuperMap.Feature.Vector(v),f=s;f.type="text-region",y.attributes=f,i.push(y)}}layer_region.addFeatures(a),layer_region_label.addFeatures(i)},Map.clear=function(){$("#btn_showBranch, #btn_showRegion").prop("checked",!1),$("#btn_showRegion").removeAttr("isShowRegion"),layer_region.removeAllFeatures(),layer_region.setVisibility(!1),layer_region_label.removeAllFeatures(),layer_region_label.setVisibility(!1),layer_branches.removeAllFeatures(),layer_branches.setVisibility(!1),map.removeAllPopup(),Map.popup=null,Dituhui.Order.Table.clear(),layer_orders.removeAllFeatures(),layer_cloudpois.removeAllFeatures(),$(".header .search-from-cloud .child").addClass("hide"),Dituhui.Zone.Table.clear(),Measure.control.deactivate(),layer_edit.removeAllFeatures(),control_drawPolygon.deactivate(),Map.regionAdding=!1,control_editPolygon.deactivate(),control_drawSplitLine.deactivate(),Regionroute.cancel(),control_drawSplitArea.deactivate(),Map.enableDrag(),Measure.clear()},Map.pan=function(){map.removeAllPopup(),Map.popup=null,Measure.control.deactivate(),control_drawPolygon.deactivate(),Map.regionAdding=!1,control_editPolygon.deactivate(),Map.enableDrag(),control_drawSplitArea.deactivate(),control_drawSplitLine.deactivate(),layer_edit.removeAllFeatures()},Map.search=function(){Map.searchRegions()},Map.getFeatureFromLayerById=function(e,t){var t=layer_region.features,a=t.length;if(1>a)return null;for(var i=a;i--;){var r=t[i];if(r.attributes.id===e)return r}return null},Map.addRegionClick=function(){var e=Map.checkAction();e&&($("#btn_showRegion").prop("checked",!0).attr("isShowRegion","true"),layer_region.setVisibility(!0),layer_region_label.setVisibility(!0),0==layer_region.features.length&&($(".data-list .search-input").val(""),Map.search()),map.removeAllPopup(),control_select.deactivate(),control_drawPolygon.activate(),Map.disableDrag(),Map.regionAdding=!0,Map.setMapIndexTop())},Map.regionAdding=!1,Map.drawRegionCompleted=function(e){control_drawPolygon.deactivate(),Map.enableDrag(),e.feature.style=Dituhui.Zone.getRegionStyle(),layer_edit.redraw();var t=e.feature.geometry.getCentroid(),a=new SuperMap.LonLat(t.x,t.y);Map.openAddRegionPopup(a)},Map.openAddRegionPopup=function(e){var t=Dituhui.Zone.getEditRegionHtml(0);Map.popup=new SuperMap.Popup.FramedCloud("popup-region",e,new SuperMap.Size(300,200),t,null,!1,null,!0),Map.popup.autoSize=!0,Map.popup.panMapIfOutOfView=!0,Map.popup.relativePosition="tr",map.removeAllPopup(),map.addPopup(Map.popup),$("#txt_number").unbind("keyup").keyup(function(e){13==e.keyCode&&Map.getBranchName()}),$(".popup-close").unbind("click").on("click",function(){Dituhui.Modal.ask("确定不保存吗？",Map.cancelAddRegion)}),$(".popup-sure").unbind("click").on("click",Map.addRegion),Dituhui.Zone.initRegionPopupAdmincode(null)},Map.getBranchName=function(){var e=$("#txt_number").val();if(""===e||e.length<1)return void Dituhui.showHint("请输入区划编号");if(e.length>50)return void(hint.text="区划编号长度不能大于50位");var t=$("#txt_name").val();""!=t||t.length>0||Dituhui.Zone.getBranchNameByAreaNumber(e,function(e){if(e&&e.isSuccess&&e.result&&e.result.pointname){var t="",a=e.result.oldpointnames,i=e.result.pointname,r=e.result.pointid;if(a&&a.length>0){var n=a.length;if(n>0)for(var o=0;n>o;o++)t+=a[o],n-1>o&&(t+=",")}""!=t?Dituhui.Modal.alert('该区划已绑定网点"'+t+'"，确定要解除吗？',function(){$("#txt_name").val(i).attr("poi-id",r)},null):$("#txt_name").val(i).attr("poi-id",r)}else{var l=e&&e.info?e.info:"获取网点名称失败";Dituhui.showHint(l)}},function(e){var e=e?e:"获取网点名称失败";Dituhui.showHint(e)})},Map.addRegion=function(){var e=layer_edit.features[0],t=$("#txt_name").val();if(""===t||t.length<1)return void Dituhui.showHint("请输入区划名称");if(t.length>50)return void Dituhui.showHint("区划名称长度不能大于50位");var a=$("#txt_number").val();if(""===a||a.length<1)return void Dituhui.showHint("请输入区划编号");if(a.length>50)return void Dituhui.showHint("区划编号长度不能大于50位");var i=$("#select_region_province").val(),r=$("#select_region_city").val(),n=$("#select_region_county").val(),o=Dituhui.User.hasTownAuthority?$("#select_region_town").val():"-1",l="";if(Dituhui.User.hasTownAuthority&&o&&"-1"!=o)l=o;else if(n&&"-1"!=n)l=n;else if(r&&"-1"!=r)l=r;else{if(!i||"-1"==i)return void Dituhui.showHint("请选择区划归属");l=i}var u=$("#txt_name").attr("poi-id"),s={areaName:t,areaNum:a,point2Ds:Dituhui.Zone.getPoint2DsFromRegion(e,"region",Baidu.using),parts:Dituhui.Zone.getPartsFromRegion(e),admincode:l,pointid:u};Dituhui.User.regionTableExtend&&(s.wgzCode=$("#txt_wgzCode").val(),s.wgzName=$("#txt_wgzName").val(),s.lineCode=$("#txt_lineCode").val(),s.lineName=$("#txt_lineName").val()),Dituhui.Zone.add(s,function(){Dituhui.showPopover("区划添加成功"),map.removeAllPopup(),layer_edit.removeAllFeatures(),Map.search(),control_select.activate(),Map.regionAdding=!1,Map.clearSelectedFeatures()},function(e){control_select.activate(),Map.regionAdding=!0,e&&""!==e?Dituhui.Modal.loaded_wrong(e,function(){$(".data-modal").addClass("hide")}):Dituhui.showHint("新增区划失败，请稍候重试")})},Map.cancelAddRegion=function(){map.removeAllPopup(),layer_edit.removeAllFeatures(),layer_region_temp.removeAllFeatures(),layer_region_label_temp.removeAllFeatures(),$(".data-modal").addClass("hide"),Map.regionAdding=!1,control_select.activate(),relatedSelect.deactivate(!0)},Map.attrRegionClick=function(){var e=Map.checkAction();if(e){if(null==selectedFeature||1!=selectedFeatures.length)return void Dituhui.showHint("请先选择一个区划");var t=selectedFeature.geometry.getCentroid();map.panTo(new SuperMap.LonLat(t.x,t.y)),Map.openRegionAttrPopup(selectedFeature)}},Map.deleteRegionClick=function(){var e=Map.checkAction();if(e){if(null==selectedFeature||1!=selectedFeatures.length)return void Dituhui.showHint("请选择待删除的区划");var t=selectedFeature.attributes;$('button[option="delete-region"]').attr({"data-id":t.id,"data-name":t.name}),$(".delete-region-name").html(t.name),Dituhui.Modal.alert("是否删除区划 <strong>"+t.name+"</strong> ? 删除后不可恢复。",Map.deleteRegion,{"data-id":t.id,"data-name":t.name})}},Map.deleteRegion=function(){var e=$(this);Dituhui.Zone.remove(e.attr("data-id"),function(){$(".data-modal").addClass("hide"),Dituhui.showPopover('区划"'+e.attr("data-name")+'"删除成功'),Map.search(),map.removeAllPopup(),Map.clearSelectedFeatures()},function(t){$(".data-modal").addClass("hide"),""==t&&(t='区划"'+e.attr("data-name")+'"删除失败'),Dituhui.Modal.loaded_wrong(t,function(){Dituhui.Modal.hide()})})},Map.mergeRegionClick=function(){var e=Map.checkAction();if(e){if(selectedFeatures.length<2)return void Dituhui.showHint("请先选择至少两个区划, 按住ctrl可同时多选区划");map.removeAllPopup();for(var t=selectedFeatures.concat(),a=selectedFeatures[0].attributes.name,i="",r=0,n=t.length;n>r;r++)i+=t[r].attributes.id+(n-1>r?"_":"");Dituhui.Modal.ask("是否合并所选区划？合并后区划属性为“"+a+"”。",Map.mergeRegions,{"data-id":i})}},Map.mergeRegions=function(e){Dituhui.Zone.merge(e["data-id"],function(){$(".data-modal").addClass("hide"),Dituhui.showPopover("区划合并成功"),Map.search(),map.removeAllPopup(),Map.clearSelectedFeatures()},function(e){$(".data-modal").addClass("hide"),e=""==e?"区划合并失败":e,Dituhui.showHint(e),Map.clearSelectedFeatures()})},Map.lineSplitRegionClick=function(){var e=Map.checkAction();if(e){if(null==selectedFeature||1!=selectedFeatures.length)return void Dituhui.showHint("请选择待拆分的区划");Dituhui.showHint("请绘制与选中区划相交叉的线"),map.removeAllPopup(),control_drawSplitLine.activate(),Map.setMapIndexTop()}},Map.drawSplitLineCompleted=function(e){control_drawSplitLine.deactivate();var t=e.feature.clone();t.style=Dituhui.Zone.getSplitLineStyle(),layer_edit.removeAllFeatures(),layer_edit.addFeatures([t]),Dituhui.Modal.ask("确定要拆分该区划吗？",Map.lineSplitRegion,{},function(){layer_edit.removeAllFeatures()
})},Map.lineSplitRegion=function(){var e=layer_edit.features[0],t={id:selectedFeature.attributes.id,point2Ds:Dituhui.Zone.getPoint2DsFromRegion(e,"line",Baidu.using)};Dituhui.Zone.lineSplit(t,function(){$(".data-modal").addClass("hide"),Dituhui.showPopover("区划线拆分成功"),Map.search(),map.removeAllPopup(),layer_edit.removeAllFeatures(),Map.clearSelectedFeatures()},function(e){$(".data-modal").addClass("hide"),layer_edit.removeAllFeatures(),e=""==e?"区划线拆分删除失败":e,Dituhui.showHint(e),Map.clearSelectedFeatures()})},Map.areaSplitRegionClick=function(){var e=Map.checkAction();if(e){if(null==selectedFeature||1!=selectedFeatures.length)return void Dituhui.showHint("请选择待拆分的区划");Dituhui.showHint("请绘制与选中区划相交叉的面"),map.removeAllPopup(),control_drawSplitArea.activate(),Map.setMapIndexTop()}},Map.drawSplitAreaCompleted=function(e){control_drawSplitArea.deactivate();var t=e.feature.clone();t.style=Dituhui.Zone.getSplitAreaStyle(),layer_edit.removeAllFeatures(),layer_edit.addFeatures([t]),Dituhui.Modal.ask("确定要拆分该区划吗？",Map.areaSplitRegion,{},function(){layer_edit.removeAllFeatures()})},Map.areaSplitRegion=function(){var e=layer_edit.features[0],t={id:selectedFeature.attributes.id,point2Ds:Dituhui.Zone.getPoint2DsFromRegion(e,"region",Baidu.using),operType:2};Dituhui.Zone.lineSplit(t,function(){$(".data-modal").addClass("hide"),Dituhui.showPopover("区划面拆分成功"),Map.search(),map.removeAllPopup(),layer_edit.removeAllFeatures(),Map.clearSelectedFeatures()},function(e){$(".data-modal").addClass("hide"),e=""==e?"区划面拆分失败":e,Dituhui.showHint(e),layer_edit.removeAllFeatures(),Map.clearSelectedFeatures()})},Map.setPan=function(){},Map.checkAction=function(){return control_drawPolygon.active||Map.regionAdding?(Dituhui.showHint("正在进行自由画区操作"),!1):control_editPolygon.active?(Dituhui.showHint('正在编辑区划"'+selectedFeature.attributes.name+'"的节点'),!1):control_drawPathRegion.active?(Dituhui.showHint("正在进行沿路画区操作"),!1):control_drawSplitLine.active?(Dituhui.showHint('正在对区划"'+selectedFeature.attributes.name+'"进行线拆分操作'),!1):control_drawSplitArea.active?(Dituhui.showHint('正在对区划"'+selectedFeature.attributes.name+'"进行面拆分操作'),!1):!0},Map.regionImportClick=function(){$(".select-region-import").click()},Map.regionImport=function(){var e={success:function(e){Dituhui.hideMask(),e.isSuccess?(Dituhui.showPopover("导入区划边界成功"),Map.search()):Dituhui.Modal.loaded_wrong(e.info,function(){Dituhui.Modal.hide()})},error:function(){Dituhui.hideMask()},timeout:3e4};Dituhui.showMask(),$("#form_import_region").ajaxSubmit(e)},Map.regionExport=function(){if(null==selectedFeatures||selectedFeatures.length<1)return void Dituhui.showHint("请先选择需要导出的区划");for(var e=selectedFeatures.length,t="",a=e;a--;){var i=selectedFeatures[a];t+=i.attributes.id,0!=a&&(t+="_")}var r=(new Date).getTime()+"";window.open(urls.server+"/areaService/export?&t="+r+"&ids="+t,"_blank")},Map.bindKeyPan=function(){$("#map").keyup(function(e){var e=e||event,t=150;switch(e.keyCode){case 37:map.pan(-t,0);break;case 38:map.pan(0,-t);break;case 39:map.pan(t,0);break;case 40:map.pan(0,t)}}).on("click",function(){Map.setMapIndexTop()})},Map.setMapIndexTop=function(){$("#map").attr("tabindex",0).focus()},Map.setUserBelonging=function(){if(!selectedFeature)return void Dituhui.showHint("请先选择一个区划");var e=selectedFeature.attributes.id,t=$.fn.zTree.getZTreeObj("tree_usebelonging"),a=t.getSelectedNodes(!0)[0],i=a.id;Dituhui.Zone.setUserBelonging(e,i,function(){Dituhui.showPopover("更新区划所属用户成功"),$(".data-user-belonging").fadeOut("slow"),Map.searchRegions()},function(e){Dituhui.showHint(e?e:"更新区划所属用户失败")})},Map.checkRegionsCount=function(){var e=$(".smcity"),t=(e.attr("admincode"),e.attr("level"));return 0==t?void Dituhui.showHint("请选择省、市、区"+(Dituhui.User.hasTownAuthority?"或乡镇":"")):($("#btn_showRegion").prop("checked",!0).attr("isShowRegion","true"),layer_region.setVisibility(!0),layer_region_label.setVisibility(!0),0==layer_region.features.length?($(".data-list .search-input").val(""),void Map.searchRegions(Map.saveReverseSelectionArea)):void Map.saveReverseSelectionArea())},Map.saveReverseSelectionArea=function(){var e=$(".smcity"),t=e.attr("admincode"),a=e.attr("level");currentAdminame=e.attr("adminname");var i=$(".smcity-title a.city:not(.hide)").attr("data-value");"undefined"!=typeof i?i+="/":i="";var r=currentAdminame;switch(a){case"2":r=$(".smcity-title a.province").attr("data-value")+"/"+r;break;case"3":r=$(".smcity-title a.province").attr("data-value")+"/"+i+r;break;case"4":r=$(".smcity-title a.province").attr("data-value")+"/"+i+$(".smcity-title a.county").attr("data-value")+"/"+r}var n=Number($(".data-list .totality").attr("data-value")),o="当前为"+currentAdminame+(1!=a?"（"+r+"）":"")+"，已有区划"+n+"个，确定将空白区域按照红色行政边界转化为业务区划？";Dituhui.Modal.ask(o,function(){Dituhui.Modal.hide(),Dituhui.showMask(),Dituhui.Zone.saveReverseSelectionArea(t,a,function(e){Map.searchRegions(function(){Map.autoSelectFeature(e),Dituhui.Modal.loaded_right("区划已经生成，请填写区划名称和编号",function(){Dituhui.Modal.hide()})})},function(e){Dituhui.Modal.loaded_wrong(e||"区划生成失败，请重新操作",Dituhui.Modal.hide)})})},Map.autoSelectFeature=function(e){var t=Map.getFeatureFromLayerById(e,layer_region.features);t.attributes.oldStyle=t.style,t.style=Dituhui.Zone.getRegionSelectStyle(),selectedFeature=t,selectedFeatures.push(selectedFeature),Dituhui.Zone.Table.scrollToFeature(t);var a=t.attributes;if(a.lonlat=new SuperMap.LonLat(a.center.x,a.center.y),Map.openEditRegionPopup(a,!0),0==layer_region.visibility){var i=selectedFeature.attributes,r=new SuperMap.Geometry.GeoText(i.center.x,i.center.y,i.name),n=new SuperMap.Feature.Vector(r);n.style=Dituhui.Zone.getRegionTextStyle(),layer_region_temp.addFeatures([selectedFeature.clone()]),layer_region_label_temp.addFeatures([n])}layer_region.redraw()};var poisearch;$(function(){var e=urls.getUrlArgs();if(Dituhui.User.currentModuleId=e&&e.moduleid?e.moduleid:"",$('li[option="show-children"]').hover(function(){$(this).find(" > div").show()},function(){$(this).find(" > div").hide()}),$(".close, .btn-cancel, .close-modal").click(function(){var e=$(this);e.hasClass("close-fade-out")?$(e.attr("data-target")).fadeOut("fast"):$(e.attr("data-target")).addClass("hide"),".data-update-style"==e.attr("data-target")&&$('button[option="update-style"]').unbind("click").click(Map.Style.edit)}),$("#btn_showBranch").change(Map.showBranchLayer),$("#btn_showRegion").change(Map.showRegionLayer),$('a[option="clear-map"]').click(Map.clear),$('a[option="pan-map"]').click(Map.pan),$(".popover-result, .popover-hint").css({left:.5*(Number($(".container-region").css("width").replace("px",""))-300)+"px"}),$(".data-list .head .first").click(Page.cssTableFirst),$("#btn_showCountryBoundry").on("change",Map.showCountryBoundry),$(".region-import").on("click",Map.regionImportClick),$(".region-export").on("click",Map.regionExport),$(".select-region-import").on("change",Map.regionImport),$("#form_import_region").attr("action",urls.server+"/areaService/import?&muduleId="+Dituhui.User.currentModuleId),$(".data-list .head .second").click(Page.cssTableSecond),$(".data-list .head .third").click(Page.cssTableThird),$(".data-list .head .title").click(Page.cssTableTitleClick),$(".a-data-success").click(Map.showSuccessData),$(".a-data-failed").click(Map.showFailedData),$(".data-list .search-input").keyup(function(e){13===e.keyCode&&Map.search()}),$(".data-list .btn-search").click(Map.search),"Microsoft Internet Explorer"==navigator.appName){var t=navigator.appVersion.split(";");t=parseInt(t[1].replace(/[ ]/g,"").replace(/MSIE/g,"")),10>t&&($(".btn-select-file").hide(),$("#txt_import_branches").css("display","block"),urls.ie_case=!0)}$(".toolbox .town").click(function(){$(".data-import-regins").show()}),$(".toolbox .add").click(Map.addRegionClick),$(".toolbox .add-path").click(Regionroute.addRouteRegionClick),$(".toolbox .attr").click(Map.attrRegionClick),$(".toolbox .edit").click(Regionedit.editRegionClick),$(".toolbox .delete").click(Map.deleteRegionClick),$(".toolbox .merge").click(Map.mergeRegionClick),$(".toolbox .line-split").click(Map.lineSplitRegionClick),$(".toolbox .area-split").click(Map.areaSplitRegionClick),$('button[option="delete-region"]').click(Map.deleteRegion),$(".btn-set-usrbelonging").on("click",Map.setUserBelonging),navigator.userAgent.indexOf("Firefox")>-1&&(isFirefox=!0,$(document).on("keydown",function(e){17==e.which&&(isCtrlKeydown=!0)}),$(document).on("keyup",function(e){17==e.which&&setTimeout(function(){isCtrlKeydown=!1},300)})),Page.initcss(),$(window).resize(Page.initcss),Map.search(),Dituhui.Zone.Table.initTrClick()});var Page={initcss:function(){setTimeout(function(){map.updateSize()},100)},cssTableFirst:function(){var e=$(this),t=$(".data-list"),a=t.attr("status");switch(a){case"min":t.attr("status","left-max"),e.removeClass("up").addClass("bottom").attr("title","向下缩放");break;case"left-max":t.attr("status","min"),e.removeClass("bottom").addClass("up").attr("title","向上展开");break;case"bottom-max":t.attr("status","min"),e.removeClass("bottom").addClass("up").attr("title","向下缩放"),t.find(".second").removeClass("up").addClass("right").attr("title","向右展开");break;case"max":t.attr("status","left-max"),e.removeClass("left").addClass("bottom").attr("title","向下缩放"),t.find(".second").removeClass("bottom").addClass("right").attr("title","向右展开")}},cssTableSecond:function(){var e=$(this),t=$(".data-list"),a=t.attr("status");switch(a){case"min":t.attr("status","bottom-max"),e.removeClass("right").addClass("up").attr("title","向上展开"),t.find(".first").removeClass("up").addClass("bottom").attr("title","向下缩放");break;case"bottom-max":t.attr("status","max"),e.removeClass("up").addClass("bottom").attr("title","向下缩放"),t.find(".first").removeClass("bottom").addClass("left").attr("title","向左缩放");break;case"max":t.attr("status","bottom-max"),e.removeClass("bottom").addClass("up").attr("title","向上展开"),t.find(".first").removeClass("left").addClass("bottom").attr("title","向下缩放");break;case"left-max":t.attr("status","max"),e.removeClass("right").addClass("bottom").attr("title","向下缩放"),t.find(".first").removeClass("bottom").addClass("left").attr("title","向左缩放")}},cssTableThird:function(){var e=$(".data-list");e.attr("status","min"),e.find(".second").removeClass("bottom").addClass("right").attr("title","向右展开"),e.find(".first").removeClass("left").addClass("up").attr("title","向上展开")},cssTableTitleClick:function(){var e=$(".data-list");"min"==e.attr("status")&&(e.attr("status","left-max"),e.find(".first").removeClass("up").addClass("bottom").attr("title","向下缩放"),e.find(".second").removeClass("bottom").addClass("right").attr("title","向右展开"))}};Regionedit={},Regionedit.editRegionClick=function(){var e=Map.checkAction();if(e){if(null==selectedFeature||1!=selectedFeatures.length)return void Dituhui.showHint("请先选择一个区划");map.removeAllPopup(),layer_region.removeFeatures([selectedFeature]),layer_edit.addFeatures(selectedFeature),Map.disableDbClick(),control_select.deactivate(),control_editPolygon.activate(),control_editPolygon.selectFeature(layer_edit.features[0]),$("#map").one("dblclick",Regionedit.done),Map.setMapIndexTop()}},Regionedit.done=function(){control_editPolygon.unselectFeature(layer_edit.features[0]),control_editPolygon.deactivate();var e="确定要修改区划"+selectedFeature.attributes.name+"的节点？";e+="<br>",e+="点击“是”提交修改，点击“否”不修改该区划，点击“取消”关闭弹窗，继续修改该区划。",Dituhui.Modal.ask(e,Regionedit.submit,null,function(){control_editPolygon.activate(),Map.setMapIndexTop(),control_editPolygon.selectFeature(layer_edit.features[0]),$("#map").one("dblclick",Regionedit.done),Dituhui.Modal.hide()},function(){Map.search(),Map.enableDbClick(),control_select.activate(),Map.clearSelectedFeatures(),Dituhui.Modal.hide(),layer_edit.removeAllFeatures()})},Regionedit.submit=function(){var e=layer_edit.features[0];Dituhui.Zone.update({id:e.attributes.id,point2Ds:Dituhui.Zone.getPoint2DsFromRegion(e,"region",Baidu.using),parts:Dituhui.Zone.getPartsFromRegion(e)},function(){Dituhui.showPopover("区划修改成功"),Map.search(),Map.enableDbClick(),control_select.activate(),Map.clearSelectedFeatures(),Dituhui.Modal.hide(),layer_edit.removeAllFeatures()},function(e){Dituhui.Modal.loaded_wrong(e,function(){Map.search(),Map.enableDbClick(),control_select.activate(),Map.clearSelectedFeatures(),Dituhui.Modal.hide(),layer_edit.removeAllFeatures()})})};var Measure={control:null,layer:null};Measure.init=function(){Measure.control=new SuperMap.Control.Measure(SuperMap.Handler.Path,{persist:!0,immediate:!0}),Measure.control.events.on({measure:Measure.handleMeasure,measurepartial:Measure.handleMeasurements,click:Measure.measureLineSegment}),Measure.control.style={fillColor:"#CC3333",strokeColor:"#CC3333",pointRadius:6},map.addControl(Measure.control),Measure.layer=new SuperMap.Layer.Vector("layer_measureFeatures"),map.addLayer(Measure.layer,2),$(".tool-button.measure").on("click",function(){var e=Map.checkAction();e&&Measure.control.activate()})},Measure.active=function(){Measure.control.activate()},Measure.clear=function(){Measure.layer.removeAllFeatures(),Measure.index=0},Measure.clearMeasure=function(e){for(var t=e.attributes,a=Measure.layer.features,i=[],r=a.length;r--;){var n=a[r];n.attributes.id===t.id&&i.push(n)}Measure.layer.removeFeatures(i)},Measure.index=0,Measure.handleMeasure=function(e){Measure.control.deactivate(),Measure.index++;var t={strokeColor:"#CC3333",strokeOpacity:1,strokeWidth:3,pointRadius:6},a=e.geometry,i=new SuperMap.Feature.Vector(a,null,t);i.attributes={id:"measure-line-"+Measure.index},Measure.layer.addFeatures(i);for(var r,n,o=a.components.length,l=0;o>l;l++){var u=a.components[l],s=new SuperMap.Geometry.Point(u.x,u.y),c=new SuperMap.Feature.Vector(s,{id:"measure-line-"+Measure.index});c.style={fillColor:"#fffff",strokeColor:"#FF0000",pointRadius:5,strokeOpacity:.5,fillOpacity:.5},Measure.layer.addFeatures(c),0==l?r=s:l==o-1&&(n=s)}var d;d="km"==e.units?"公里":"米";var p=e.measure.toFixed(3),h=new SuperMap.Feature.Vector(new SuperMap.Geometry.Point(r.x,r.y),{type:"measure",id:"measure-line-"+Measure.index},{externalGraphic:urls.server+"/resources/images/measure/begin.gif",graphicWidth:34,graphicHeight:19,graphicXOffset:-17,graphicYOffset:-25}),g=new SuperMap.Feature.Vector(new SuperMap.Geometry.Point(n.x,n.y),{type:"clear-measure",id:"measure-line-"+Measure.index},{externalGraphic:urls.server+"/resources/images/measure/close1.gif",graphicWidth:12,graphicHeight:12,graphicXOffset:-15,graphicYOffset:-15,graphicTitle:"清除本次测量结果",cursor:"pointer"}),m=new SuperMap.Feature.Vector(new SuperMap.Geometry.Point(n.x,n.y),{type:"measure",id:"measure-line-"+Measure.index},{externalGraphic:urls.server+"/resources/images/measure/back.png",graphicWidth:106,graphicHeight:20,graphicXOffset:6,graphicYOffset:-10,cursor:"pointer",label:"总长："+p+d,fontColor:"black",fontFamily:"microsoft yahei",fontWeight:"normal",labelXOffset:56});Measure.layer.addFeatures([h,g,m])},$(function(){$(".path-region-content .undo").on("click",Regionroute.undo),$(".path-region-content .done").on("click",Regionroute.done),$(".path-region-content .cancel").on("click",Regionroute.cancel),$(".path-region-content .drag").on("click",function(){var e=$(this);e.hasClass("active")?(Regionroute.disableDrag(),e.html("拖动节点")):(Regionroute.enableDrag(),e.html("完成拖动")),e.toggleClass("active")})});var Regionroute={drawing:!1,drag:null,dragging:!1};Regionroute.addRouteRegionClick=function(){var e=Map.checkAction();e&&(control_select.deactivate(),layer_edit.removeAllFeatures(),control_drawPathRegion.activate(),Map.setMapIndexTop(),$("#btn_showRegion").prop("checked",!0).attr("isShowRegion","true"),layer_region.setVisibility(!0),layer_region_label.setVisibility(!0),0==layer_region.features.length&&Map.search(),Regionroute.drawing=!0,$(".path-region-content").removeClass("hide"),Regionroute.drag=new SuperMap.Control.DragFeature(layer_edit),Regionroute.drag.onComplete=function(e,t){var a=map.getLonLatFromPixel(t);e.attributes.lonlat=a;var i,r=Number(e.attributes.index)-1,n=layer_edit.features.length-1,o=layer_edit_regionroute.features.length;n>r&&r>0?(o>r&&layer_edit_regionroute.removeFeatures([layer_edit_regionroute.features[r],layer_edit_regionroute.features[r-1]]),Regionroute.getPathWithPassPoints(r-1,r,r)):1>r?(i=layer_edit_regionroute.features[0],i&&layer_edit_regionroute.removeFeatures([layer_edit_regionroute.features[0]]),Regionroute.getPathWithPassPoints(0,1)):r===n&&(i=layer_edit_regionroute.features[r-1],i&&layer_edit_regionroute.removeFeatures([layer_edit_regionroute.features[r-1]]),Regionroute.getPathWithPassPoints(r-1,r))},map.addControl(Regionroute.drag))},Regionroute.drawRouteRegionCompleted=function(e){var t=e.feature.clone(),a=layer_edit.features.length;t.style=Dituhui.Zone.getRouteRegionPointStyle(a+""),t.attributes.index=a,layer_edit.removeFeatures([e.feature]),layer_edit.addFeatures([t]);var i=layer_edit.features.length;i>1&&Regionroute.getPath(i-2,i-1)},Regionroute.getPath=function(e,t,a){Regionroute.duringGetPath();var i,r=layer_edit.features[e].geometry.components[0];i=Baidu.using?Baidu.restoreCoord(r.x,r.y,"lonlat"):Dituhui.metersToLatLon(new SuperMap.LonLat(r.x,r.y));var i,n=layer_edit.features[t].geometry.components[0];end=Baidu.using?Baidu.restoreCoord(n.x,n.y,"lonlat"):Dituhui.metersToLatLon(new SuperMap.LonLat(n.x,n.y));var o=JSON.stringify({startPoint:{x:Number(i.lon.toFixed(5)),y:Number(i.lat.toFixed(5))},endPoint:{x:Number(end.lon.toFixed(5)),y:Number(end.lat.toFixed(5))},passPoints:[],routeType:"MINLENGTH"}),l={parameter:o};Dituhui.Zone.getPathFromCloud(l,function(e){if(Regionroute.afterGetPath(),e.success===!1||!e.result||!e.result.path||0===e.result.path.length)return Dituhui.showHint("路径分析失败，请重新画点"),void Regionroute.undo();var t=Dituhui.Zone.drawLineLonLat(e.result.path,Baidu.using),i=new SuperMap.Feature.Vector(t,null,Dituhui.Zone.getPathRegionLineStyle());layer_edit_regionroute.addFeatures([i]),a===!0&&(control_drawPathRegion.deactivate(),Regionroute.createRegion())},function(e){Regionroute.afterGetPath(),Dituhui.showHint(e)})},Regionroute.duringGetPath=function(){control_drawPathRegion.deactivate(),Dituhui.showMask()},Regionroute.afterGetPath=function(){Dituhui.hideMask(),Regionroute.drawing&&!Regionroute.dragging&&(control_drawPathRegion.activate(),Map.setMapIndexTop())},Regionroute.undo=function(){var e=layer_edit.features.length-1;if(!(0>e)){var t=layer_edit.features[e];if(layer_edit.removeFeatures([t]),!(0>e-1)&&layer_edit_regionroute.features.length===e){var a=layer_edit_regionroute.features[e-1];layer_edit_regionroute.removeFeatures([a])}}},Regionroute.done=function(){if(Regionroute.drawing){var e=layer_edit.features.length;if(3>e)return void Dituhui.showHint("沿路画区至少需要3个点");Regionroute.getPath(e-1,0,!0),Regionroute.drag.deactivate(),Regionroute.drag.destroy(),map.removeControl(Regionroute.drag),control_select.activate()}},Regionroute.cancel=function(){control_drawPathRegion.deactivate(),layer_edit.removeAllFeatures(),layer_edit_regionroute.removeAllFeatures(),Regionroute.drawing=!1,$(".path-region-content").addClass("hide"),Regionroute.dragging&&(Regionroute.drag.deactivate(),Regionroute.drag.destroy(),Regionroute.dragging=!1,$(".path-region-content .drag").html("拖动节点").removeClass("active")),control_select.activate()},Regionroute.enableDrag=function(){control_drawPathRegion.deactivate(),Regionroute.drag.activate(),Regionroute.dragging=!0},Regionroute.disableDrag=function(){Regionroute.drag.deactivate(),control_drawPathRegion.activate(),Map.setMapIndexTop(),Regionroute.dragging=!1},Regionroute.createRegion=function(){for(var e=layer_edit_regionroute.features,t=[],a=0,i=e.length;i>a;a++)for(var r=e[a],n=r.geometry.components,o=0,l=n.length;l>o;o++)t.push(new SuperMap.Geometry.Point(n[o].x,n[o].y));var u=Dituhui.Zone.DrawRegion([t.length],t),s=new SuperMap.Feature.Vector(u,null,Dituhui.Zone.getRegionStyle());layer_edit_regionroute.removeAllFeatures(),layer_edit.removeAllFeatures(),layer_edit.addFeatures([s]);var c=s.geometry.getCentroid(),d=new SuperMap.LonLat(c.x,c.y);Map.openAddRegionPopup(d),$(".path-region-content").addClass("hide")},Regionroute.getPathWithPassPoints=function(e,t,a){Regionroute.duringGetPath();var i=layer_edit.features[e].geometry.getCentroid(),r=Dituhui.metersToLatLon(new SuperMap.LonLat(i.x,i.y)),n=layer_edit.features[t].geometry.getCentroid(),o=Dituhui.metersToLatLon(new SuperMap.LonLat(n.x,n.y)),l={startPoint:{x:Number(r.lon.toFixed(5)),y:Number(r.lat.toFixed(5))},endPoint:{x:Number(o.lon.toFixed(5)),y:Number(o.lat.toFixed(5))},passPoints:[],routeType:"MINLENGTH"},u=JSON.stringify(l);Dituhui.Zone.getPathFromCloud({parameter:u},function(t){if(Regionroute.afterGetPath(),t.success!==!1&&t.result&&t.result.path&&0!==t.result.path.length){var i=t.result.path;Regionroute.showDarggedPath(i,e,a)}else Dituhui.showHint("路径分析失败，请重新拖动")},function(){Regionroute.afterGetPath(),Dituhui.showHint("路径分析失败，请重新拖动")})},Regionroute.showDarggedPath=function(e,t,a){var i=Dituhui.Zone.drawLineLonLat(e),r=new SuperMap.Feature.Vector(i,null,Dituhui.Zone.getPathRegionLineStyle()),n=layer_edit_regionroute.features.length,o=layer_edit.features.length;t=0>t?0:t,t=t>n?n:t;var l=layer_edit_regionroute.features;if(l.splice(t,0,r),layer_edit_regionroute.removeAllFeatures(),layer_edit_regionroute.addFeatures(l),isNaN(a)){if(!Regionroute.drawing&&(0===t||t===n-1)){var u=layer_add_region.features[o-1];u&&layer_add_region.removeFeature(u),Regionroute.getPathWithPassPoints(o-1,0)}}else Regionroute.getPathWithPassPoints(a,a+1)};var Rightmenu={menu:null,isFeature:!1,createMenu:function(e){if("region"===e.attributes.type){if(Map.regionSelect(e,!1),$(".feature-right-menu li").addClass("hide"),selectedFeatures.length<1)return;1==selectedFeatures.length?$(".feature-right-menu").find(".r-attr, .r-delete, .r-pan").removeClass("hide"):$(".feature-right-menu").find(".r-merge, .r-pan").removeClass("hide");var t=this.handlers.feature.up;$(".feature-right-menu").css({left:t.x+3+"px",top:t.y+"px",visibility:"visible"}),Rightmenu.isFeature=!0}}};$(function(){map.events.on({movestart:function(){Rightmenu.menu&&(Rightmenu.menu.style.visibility="hidden")},click:function(){Rightmenu.menu&&(Rightmenu.menu.style.visibility="hidden")}}),map.events.register("mousedown");var e={addHandler:function(e,t,a){e.addEventListener?e.addEventListener(t,a,!1):e.attachEvent&&e.attachEvent("on"+t,a)},getEvent:function(e){return e?e:window.event},preventDefault:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1}};e.addHandler(window,"load",function(){Rightmenu.menu=$("#featureRightMenu")[0],e.addHandler($("#map")[0],"contextmenu",function(t){t=e.getEvent(t),e.preventDefault(t),Rightmenu.isFeature||($(".feature-right-menu li").addClass("hide"),$(".feature-right-menu").find(".r-pan").removeClass("hide"),Rightmenu.menu.style.left=t.offsetX+3+"px",Rightmenu.menu.style.top=t.offsetY+"px",Rightmenu.menu.style.visibility="visible"),Rightmenu.isFeature=!1}),e.addHandler(document,"click",function(){Rightmenu.menu.style.visibility="hidden"})}),$(".feature-right-menu .r-attr").on("click",Map.attrRegionClick),$(".feature-right-menu .r-delete").on("click",Map.deleteRegionClick),$(".feature-right-menu .r-merge").on("click",Map.mergeRegionClick),$(".feature-right-menu .r-pan").on("click",Map.pan)});var ztree_setting={async:{enable:!0,url:urls.server+"/user/getChildUsers",autoParam:["parentId"],dataFilter:filter},callback:{onAsyncSuccess:zTreeOnAsyncSuccess,asyncError:zTreeOnAsyncError,beforeClick:beforeClick,onClick:selectOtherUser}};$(document).ready(function(){$.fn.zTree.init($("#tree_usebelonging"),ztree_setting)}),$(function(){var e=new AdminRegion;e.getProcess(function(t,a){if(a!==t&&0!=t){var i='行政区划导入中，【<span class="upload-process">'+a+"</span>/"+t+"】";Dituhui.Modal.loading(i),e.startProcessTimer(),e.autoload=!0}});var t=null;$("#shuttle_province").on("click","li",function(){var a=$(this),i=a.attr("code");clearTimeout(t),isFirefox&&isCtrlKeydown||!isFirefox&&window.event.ctrlKey?e.onSelect(a):t=setTimeout(function(){e.setCity(i)},300)}),$("#shuttle_province").on("dblclick","li",function(){var a=$(this);clearTimeout(t),e.onSelect(a)}),$("#shuttle_city").on("click","li",function(){var a=$(this),i=a.attr("code");return clearTimeout(t),isFirefox&&isCtrlKeydown||!isFirefox&&window.event.ctrlKey?void e.onSelect(a):void(t=setTimeout(function(){e.setCounty(i)},300))}),$("#shuttle_city").on("dblclick","li",function(){var a=$(this);clearTimeout(t),e.onSelect(a)}),$("#shuttle_county").on("click","li",function(){var a=$(this),i=a.attr("code");return clearTimeout(t),isFirefox&&isCtrlKeydown||!isFirefox&&window.event.ctrlKey?void e.onSelect(a):void(t=setTimeout(function(){e.setTown(i)},300))}),$("#shuttle_county").on("dblclick","li",function(){var a=$(this);clearTimeout(t),e.onSelect(a)}),$("#shuttle_town").on("dblclick","li",function(){var a=$(this);return clearTimeout(t),isFirefox&&isCtrlKeydown||!isFirefox&&window.event.ctrlKey?void e.onSelect(a):void e.onSelect(a)}),$("#shuttle_town").on("click","li",function(){if(isFirefox&&isCtrlKeydown||!isFirefox&&window.event.ctrlKey){var a=$(this);return clearTimeout(t),void e.onSelect(a)}}),$("#selected_adminnames").on("click","li .glyphicon",e.removeSelectedAdmin),$(".btn-import-adminregions").on("click",e.save),$(".data-import-regins .close-fade-out").on("click",function(){$(".data-import-regins").fadeOut(),e.clear()})});